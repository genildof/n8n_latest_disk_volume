# ============================================================
# n8n (latest) + FFmpeg — Easypanel via GitHub
# ============================================================
# Easypanel:
#   - Create Project → Service → App
#   - Source: connect GitHub repo (Dockerfile + this file)
#   - Domains: add your domain — Easypanel provisions SSL via Traefik
#   - Environment: set N8N_HOST, WEBHOOK_URL, N8N_ENCRYPTION_KEY
#
# Before deploying, create the log folder on the host server:
#   sudo mkdir -p /opt/n8n/logs/dark_video_errors
#   sudo chown -R 1000:1000 /opt/n8n/logs
# ============================================================

services:
  n8n:
    image: ${EASYPANEL_IMAGE:-n8n-ffmpeg:latest}
    container_name: n8n
    restart: unless-stopped

    ports:
      - "5678:5678"

    environment:
      N8N_HOST: ${N8N_HOST}
      N8N_PORT: "5678"
      N8N_PROTOCOL: "https"
      WEBHOOK_URL: ${WEBHOOK_URL}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      N8N_SECURE_COOKIE: "true"

      # Task Runners — required on n8n 2.x for Code nodes using fs/child_process
      N8N_RUNNERS_ENABLED: "true"
      N8N_RUNNERS_MODE: "internal"
      NODE_FUNCTION_ALLOW_BUILTIN: "fs,child_process,os,path,buffer"
      NODE_FUNCTION_ALLOW_EXTERNAL: ""

      # ExecuteCommand node — disabled by default in n8n 2.x, re-enabled here
      N8N_ALLOW_EXEC: "true"

      # Binary data — in-memory mode removed in n8n 2.x
      N8N_DEFAULT_BINARY_DATA_MODE: "filesystem"

      DB_TYPE: "sqlite"

      GENERIC_TIMEZONE: "America/Sao_Paulo"
      TZ: "America/Sao_Paulo"

      EXECUTIONS_DATA_PRUNE: "true"
      EXECUTIONS_DATA_MAX_AGE: "168"
      EXECUTIONS_DATA_MAX_COUNT: "5000"

      N8N_LOG_LEVEL: "info"

    volumes:
      - n8n_data:/home/node/.n8n
      - /opt/n8n/logs:/home/n8n/logs

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

volumes:
  n8n_data:
    driver: local
